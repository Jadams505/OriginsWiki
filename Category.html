<!DOCTYPE HTML>
<html lang="en">
	<head>
		<script>
			var catNames = window.location.search.substring(1).split('&');
			function preParseCallback(){
				if(catNames.length <= 0 || !catNames[0]){
					var firstHeader = document.getElementsByTagName("h1");
					firstHeader[0].innerText = 'Categories';
					postParseCallback = async ()=>{
						var content = document.getElementById('content');
						var categories = await getCategories();
						
						var catContents = '';
						for(var key in categories){
							console.log('cat: '+key);
							var cat = categories[key];
							console.log(cat);
							var count = cat.items.length;
							var catCount = 0;
							for(var i = 0; i < count; i++){
								if(cat.items[i].startsWith('cat:')){
									catCount++;
								}
							}
							catContents += `<div class="catitem"><a href="?${key}">${(cat.name||key).replaceAll('_', ' ')}</a> (${catCount < count ? `${count - catCount} pages ${catCount > 0?', ':''}` : ''} ${catCount ? `${catCount} categories` : ''} )</div>`;
						}
						content.innerHTML += catContents;
					};
					return;
				}
				var firstHeader = document.getElementsByTagName("h1");
				firstHeader[0].innerText = 'Category: '+window.location.search.substring(1);
			}
			async function postParseCallback(){
				var content = document.getElementById('content');
				var siteMap = getSiteMap();
				var categories = await getCategories();
				var allCats = [];
				for (let catNum = 0; catNum < catNames.length; catNum++) {
					var category = categories[catNames[catNum]];
					var siteMap = await siteMap;
					for (var i = 0; i < category.items.length; i++) {
						if(category.items[i].slice(0, 4) === 'cat:'){
							try{
								category.items.push(...categories[category.items[i].slice(4)].items);
							}catch(error){
								console.error(error);
							}
							//category.items.splice(i,1);
						}
					}
					allCats.push(category);
				}
				var catContents = '';
				console.log(category.items);
				for (var i = 0; i < siteMap.length; i++) {
					if(allCats.every(category => category.items.includes(siteMap[i]) ^ category.blacklist)){
						catContents += `<div class="catitem"><a href="${siteMap[i]+linkSuffix}">${siteMap[i].replaceAll('_', ' ')}</a></div>`;
					}
				}
				content.innerHTML += catContents;
			};
		</script>
		<script src="automarkdown.js" defer></script>
		<script>
		</script>
		<link rel="stylesheet" href="styling.css"></link>
	</head>
	<body>
		<article id="content">
			<h1>Category: </h1>
			<div class="divider"></div>

		</article>
	</body>
</html>